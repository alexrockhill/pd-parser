<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Find Photodiode On and Off Events &#8212; pd-parser v0.5dev0 documentation</title>
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/gallery.css" />
    <link rel="stylesheet" type="text/css" href="../_static/gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../_static/gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/gallery-rendered-html.css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.png"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js "></script>
<script type="text/javascript" src="../_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="../_static/bootstrap-3.3.7/js/bootstrap.min.js "></script>
<script type="text/javascript" src="../_static/bootstrap-sphinx.js "></script>

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../index.html">
          pd-parser v0.5dev0</a>
        <span class="navbar-text navbar-version pull-left"><b></b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="index.html">Examples</a></li>
                <li><a href="../api.html">API</a></li>
                <li><a href="../generated/cli.html">CLI</a></li>
                <li><a href="../whats_new.html">What's new</a></li>
                <li><a href="https://github.com/alexrockhill/pd-parser">GitHub</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"></ul>
</li>
              
            
            
            
            
            
              <li class="hidden-sm">
<div id="sourcelink">
  <a href="../_sources/auto_examples/plot_find_pd_on_and_off.rst.txt"
     rel="nofollow">Source</a>
</div></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p>Click <a class="reference internal" href="#sphx-glr-download-auto-examples-plot-find-pd-on-and-off-py"><span class="std std-ref">here</span></a>
to download the full example code</p>
</div>
<div class="sphx-glr-example-title section" id="find-photodiode-on-and-off-events">
<span id="sphx-glr-auto-examples-plot-find-pd-on-and-off-py"></span><h1>Find Photodiode On and Off Events<a class="headerlink" href="#find-photodiode-on-and-off-events" title="Permalink to this headline">¶</a></h1>
<p>In this example, we use <code class="docutils literal notranslate"><span class="pre">pd-parser</span></code> to find photodiode events and
align both the onset of the deflection and the cessation to
to behavior.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Authors: Alex Rockhill &lt;aprockhill@mailbox.org&gt;</span>
<span class="c1">#</span>
<span class="c1"># License: BSD (3-clause)</span>
</pre></div>
</div>
<p>Simulate data and use it to make a raw object:</p>
<p>We’ll make an <cite>mne.io.Raw</cite> object so that we can save out some random
data with a photodiode event channel in it in fif format (a commonly used
electrophysiology data format).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os.path</span> <span class="k">as</span> <span class="nn">op</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">mne</span>
<span class="kn">from</span> <span class="nn">mne.utils</span> <span class="kn">import</span> <span class="n">_TempDir</span>

<span class="kn">import</span> <span class="nn">pd_parser</span>
<span class="kn">from</span> <span class="nn">pd_parser.parse_pd</span> <span class="kn">import</span> <span class="n">_load_data</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.cm</span> <span class="k">as</span> <span class="nn">cm</span>

<span class="n">out_dir</span> <span class="o">=</span> <span class="n">_TempDir</span><span class="p">()</span>

<span class="c1"># simulate photodiode data</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">29</span><span class="p">)</span>
<span class="n">n_events</span> <span class="o">=</span> <span class="mi">300</span>
<span class="c1"># let&#39;s make our photodiode events on random uniform from 0.5 to 1 second</span>
<span class="n">n_secs_on</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">n_events</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="mf">0.5</span>
<span class="n">prop_corrupted</span> <span class="o">=</span> <span class="mf">0.01</span>
<span class="n">raw</span><span class="p">,</span> <span class="n">beh</span><span class="p">,</span> <span class="n">events</span><span class="p">,</span> <span class="n">corrupted_indices</span> <span class="o">=</span> \
    <span class="n">pd_parser</span><span class="o">.</span><span class="n">simulate_pd_data</span><span class="p">(</span><span class="n">n_events</span><span class="o">=</span><span class="n">n_events</span><span class="p">,</span> <span class="n">n_secs_on</span><span class="o">=</span><span class="n">n_secs_on</span><span class="p">,</span>
                               <span class="n">prop_corrupted</span><span class="o">=</span><span class="n">prop_corrupted</span><span class="p">)</span>

<span class="c1"># make fake electrophysiology data</span>
<span class="n">info</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">create_info</span><span class="p">([</span><span class="s1">&#39;ch1&#39;</span><span class="p">,</span> <span class="s1">&#39;ch2&#39;</span><span class="p">,</span> <span class="s1">&#39;ch3&#39;</span><span class="p">],</span> <span class="n">raw</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;sfreq&#39;</span><span class="p">],</span>
                       <span class="p">[</span><span class="s1">&#39;seeg&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">raw2</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">RawArray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">raw</span><span class="o">.</span><span class="n">times</span><span class="o">.</span><span class="n">size</span><span class="p">))</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
<span class="n">raw2</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;lowpass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">raw</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;lowpass&#39;</span><span class="p">]</span>  <span class="c1"># these must match to combine</span>
<span class="n">raw</span><span class="o">.</span><span class="n">add_channels</span><span class="p">([</span><span class="n">raw2</span><span class="p">])</span>
<span class="c1"># bids needs these data fields</span>
<span class="n">raw</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;dig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">raw</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;line_freq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">60</span>

<span class="c1"># add some offsets to the behavior so it&#39;s a bit more realistic</span>
<span class="n">offsets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n_events</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.01</span>
<span class="n">beh</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">beh</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="n">offsets</span>

<span class="c1"># save to disk as required by ``pd-parser``</span>
<span class="n">fname</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s1">&#39;sub-1_task-mytask_raw.fif&#39;</span><span class="p">)</span>
<span class="n">raw</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>Creating RawArray with float64 data, n_channels=1, n_times=2036104
    Range : 0 ... 2036103 =      0.000 ...  2036.103 secs
Ready.
Creating RawArray with float64 data, n_channels=3, n_times=2036104
    Range : 0 ... 2036103 =      0.000 ...  2036.103 secs
Ready.
Writing /var/folders/s4/y1vlkn8d70jfw7s8s03m9p540000gn/T/tmp_mne_tempdir_9tocoov8/sub-1_task-mytask_raw.fif
Closing /var/folders/s4/y1vlkn8d70jfw7s8s03m9p540000gn/T/tmp_mne_tempdir_9tocoov8/sub-1_task-mytask_raw.fif
[done]
</pre></div>
</div>
<p>Find the photodiode events relative to the behavioral timing of interest:</p>
<p>This function will use the default parameters to find and align the
photodiode events, excluding events that were off.
One percent of the 300 events (3) were corrupted as shown in the plots and
some were too far off from large offsets that we’re going to exclude them.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pd_parser</span><span class="o">.</span><span class="n">parse_pd</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">pd_event_name</span><span class="o">=</span><span class="s1">&#39;Stim On&#39;</span><span class="p">,</span> <span class="n">beh</span><span class="o">=</span><span class="n">beh</span><span class="p">,</span>
                   <span class="n">pd_ch_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;pd&#39;</span><span class="p">],</span> <span class="n">beh_key</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">,</span>
                   <span class="n">max_len</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>  <span class="c1"># none are on longer than 1.5 seconds</span>
</pre></div>
</div>
<ul class="sphx-glr-horizontal">
<li><img alt="Excluded Events, Excluding event 44, off by -37 ms, Excluding event 56, off by -37 ms, Excluding event 71, off by 31 ms, Excluding event 154, off by 37 ms, Excluding event 209, off by 30 ms, Excluding event 238, no event found, Excluding event 266, off by -33 ms, Excluding event 274, no event found, Excluding event 281, off by -43 ms" class="sphx-glr-multi-img" src="../_images/sphx_glr_plot_find_pd_on_and_off_001.png" />
</li>
<li><img alt="Synchronization Events Compared to Behavior Events" class="sphx-glr-multi-img" src="../_images/sphx_glr_plot_find_pd_on_and_off_002.png" />
</li>
</ul>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>Reading in /var/folders/s4/y1vlkn8d70jfw7s8s03m9p540000gn/T/tmp_mne_tempdir_9tocoov8/sub-1_task-mytask_raw.fif
Opening raw data file /var/folders/s4/y1vlkn8d70jfw7s8s03m9p540000gn/T/tmp_mne_tempdir_9tocoov8/sub-1_task-mytask_raw.fif...
Isotrak not found
    Range : 0 ... 2036103 =      0.000 ...  2036.103 secs
Ready.
Reading 0 ... 2036103  =      0.000 ...  2036.103 secs...
Finding photodiode events

  0%|          | 0/10877 [00:00&lt;?, ?it/s]
  4%|3         | 414/10877 [00:00&lt;00:02, 4136.78it/s]
  8%|7         | 844/10877 [00:00&lt;00:02, 4183.20it/s]
 11%|#1        | 1218/10877 [00:00&lt;00:02, 4039.49it/s]
 15%|#5        | 1632/10877 [00:00&lt;00:02, 4066.14it/s]
 19%|#8        | 2045/10877 [00:00&lt;00:02, 4084.06it/s]
 22%|##1       | 2385/10877 [00:00&lt;00:02, 3228.78it/s]
 25%|##4       | 2688/10877 [00:00&lt;00:02, 3055.11it/s]
 28%|##7       | 3002/10877 [00:00&lt;00:02, 3078.74it/s]
 30%|###       | 3302/10877 [00:01&lt;00:02, 2589.07it/s]
 33%|###2      | 3569/10877 [00:01&lt;00:03, 2353.49it/s]
 35%|###5      | 3830/10877 [00:01&lt;00:02, 2423.16it/s]
 38%|###7      | 4080/10877 [00:01&lt;00:02, 2371.87it/s]
 40%|####      | 4353/10877 [00:01&lt;00:02, 2468.45it/s]
 42%|####2     | 4621/10877 [00:01&lt;00:02, 2527.19it/s]
 45%|####5     | 4907/10877 [00:01&lt;00:02, 2617.72it/s]
 48%|####7     | 5182/10877 [00:01&lt;00:02, 2653.46it/s]
 50%|#####     | 5450/10877 [00:01&lt;00:02, 2626.52it/s]
 53%|#####2    | 5715/10877 [00:01&lt;00:02, 2503.10it/s]
 55%|#####4    | 5968/10877 [00:02&lt;00:01, 2483.09it/s]
 57%|#####7    | 6219/10877 [00:02&lt;00:01, 2389.86it/s]
 59%|#####9    | 6460/10877 [00:02&lt;00:01, 2377.93it/s]
 62%|######1   | 6700/10877 [00:02&lt;00:01, 2364.13it/s]
 64%|######3   | 6938/10877 [00:02&lt;00:01, 2356.37it/s]
 66%|######5   | 7175/10877 [00:02&lt;00:01, 2294.88it/s]
 68%|######8   | 7413/10877 [00:02&lt;00:01, 2315.23it/s]
 71%|#######1  | 7724/10877 [00:02&lt;00:01, 2506.99it/s]
 75%|#######4  | 8129/10877 [00:02&lt;00:00, 2829.84it/s]
 78%|#######7  | 8480/10877 [00:03&lt;00:00, 3003.57it/s]
 81%|########1 | 8842/10877 [00:03&lt;00:00, 3163.89it/s]
 85%|########4 | 9197/10877 [00:03&lt;00:00, 3269.09it/s]
 88%|########7 | 9555/10877 [00:03&lt;00:00, 3356.07it/s]
 91%|#########1| 9922/10877 [00:03&lt;00:00, 3442.88it/s]
 94%|#########4| 10273/10877 [00:03&lt;00:00, 3453.66it/s]
 98%|#########7| 10630/10877 [00:03&lt;00:00, 3483.89it/s]
100%|##########| 10877/10877 [00:03&lt;00:00, 2930.45it/s]
298 up-deflection photodiode candidate events found
Checking best alignments

  0%|          | 0/299 [00:00&lt;?, ?it/s]
  1%|1         | 3/299 [00:00&lt;00:10, 27.25it/s]
  3%|2         | 8/299 [00:00&lt;00:09, 31.46it/s]
  4%|4         | 12/299 [00:00&lt;00:08, 32.75it/s]
  5%|5         | 16/299 [00:00&lt;00:08, 31.84it/s]
  7%|7         | 21/299 [00:00&lt;00:08, 32.77it/s]
  8%|8         | 25/299 [00:00&lt;00:07, 34.41it/s]
 10%|#         | 30/299 [00:00&lt;00:07, 37.40it/s]
 11%|#1        | 34/299 [00:00&lt;00:07, 35.41it/s]
 13%|#2        | 38/299 [00:01&lt;00:07, 36.55it/s]
 14%|#4        | 42/299 [00:01&lt;00:07, 36.15it/s]
 15%|#5        | 46/299 [00:01&lt;00:07, 35.86it/s]
 17%|#6        | 50/299 [00:01&lt;00:08, 28.35it/s]
 18%|#8        | 54/299 [00:01&lt;00:09, 24.93it/s]
 19%|#9        | 57/299 [00:01&lt;00:09, 25.16it/s]
 20%|##        | 61/299 [00:01&lt;00:08, 27.37it/s]
 22%|##1       | 65/299 [00:02&lt;00:08, 29.00it/s]
 23%|##3       | 69/299 [00:02&lt;00:08, 27.81it/s]
 24%|##4       | 72/299 [00:02&lt;00:08, 27.26it/s]
 26%|##5       | 77/299 [00:02&lt;00:07, 30.97it/s]
 27%|##7       | 81/299 [00:02&lt;00:06, 31.90it/s]
 28%|##8       | 85/299 [00:02&lt;00:06, 30.74it/s]
 30%|##9       | 89/299 [00:02&lt;00:06, 30.44it/s]
 31%|###1      | 93/299 [00:02&lt;00:06, 31.96it/s]
 32%|###2      | 97/299 [00:03&lt;00:06, 31.05it/s]
 34%|###3      | 101/299 [00:03&lt;00:06, 31.48it/s]
 35%|###5      | 105/299 [00:03&lt;00:05, 33.10it/s]
 36%|###6      | 109/299 [00:03&lt;00:05, 33.78it/s]
 38%|###7      | 113/299 [00:03&lt;00:05, 34.67it/s]
 39%|###9      | 117/299 [00:03&lt;00:05, 31.13it/s]
 40%|####      | 121/299 [00:03&lt;00:05, 32.61it/s]
 42%|####1     | 125/299 [00:03&lt;00:05, 31.88it/s]
 43%|####3     | 129/299 [00:04&lt;00:05, 31.86it/s]
 44%|####4     | 133/299 [00:04&lt;00:05, 31.35it/s]
 46%|####5     | 137/299 [00:04&lt;00:05, 29.66it/s]
 47%|####7     | 141/299 [00:04&lt;00:06, 25.89it/s]
 48%|####8     | 144/299 [00:04&lt;00:06, 25.18it/s]
 49%|####9     | 147/299 [00:04&lt;00:06, 23.72it/s]
 50%|#####     | 150/299 [00:04&lt;00:06, 22.96it/s]
 51%|#####1    | 153/299 [00:05&lt;00:06, 24.30it/s]
 52%|#####2    | 156/299 [00:05&lt;00:06, 23.32it/s]
 53%|#####3    | 159/299 [00:05&lt;00:05, 24.47it/s]
 55%|#####4    | 163/299 [00:05&lt;00:05, 26.77it/s]
 56%|#####5    | 166/299 [00:05&lt;00:05, 26.54it/s]
 57%|#####6    | 170/299 [00:05&lt;00:04, 29.31it/s]
 58%|#####8    | 174/299 [00:05&lt;00:04, 29.33it/s]
 60%|#####9    | 178/299 [00:05&lt;00:04, 29.90it/s]
 61%|######    | 182/299 [00:06&lt;00:03, 29.79it/s]
 62%|######2   | 186/299 [00:06&lt;00:03, 31.99it/s]
 64%|######3   | 190/299 [00:06&lt;00:03, 31.79it/s]
 65%|######4   | 194/299 [00:06&lt;00:03, 32.83it/s]
 66%|######6   | 198/299 [00:06&lt;00:03, 33.55it/s]
 68%|######7   | 202/299 [00:06&lt;00:02, 33.26it/s]
 69%|######8   | 206/299 [00:06&lt;00:02, 33.03it/s]
 70%|#######   | 210/299 [00:06&lt;00:02, 33.99it/s]
 72%|#######1  | 214/299 [00:06&lt;00:02, 33.86it/s]
 73%|#######2  | 218/299 [00:07&lt;00:02, 34.17it/s]
 74%|#######4  | 222/299 [00:07&lt;00:02, 35.37it/s]
 76%|#######5  | 226/299 [00:07&lt;00:02, 30.78it/s]
 77%|#######6  | 230/299 [00:07&lt;00:02, 30.84it/s]
 78%|#######8  | 234/299 [00:07&lt;00:02, 30.78it/s]
 80%|#######9  | 239/299 [00:07&lt;00:01, 33.63it/s]
 82%|########1 | 244/299 [00:07&lt;00:01, 34.36it/s]
 83%|########3 | 249/299 [00:07&lt;00:01, 36.94it/s]
 85%|########4 | 253/299 [00:08&lt;00:01, 32.70it/s]
 86%|########5 | 257/299 [00:08&lt;00:01, 33.91it/s]
 88%|########7 | 262/299 [00:08&lt;00:01, 36.00it/s]
 90%|########9 | 269/299 [00:08&lt;00:00, 39.16it/s]
 92%|#########1| 274/299 [00:08&lt;00:00, 40.53it/s]
 93%|#########3| 279/299 [00:08&lt;00:00, 39.07it/s]
 95%|#########4| 284/299 [00:08&lt;00:00, 36.52it/s]
 96%|#########6| 288/299 [00:09&lt;00:00, 36.44it/s]
 98%|#########7| 292/299 [00:09&lt;00:00, 35.86it/s]
100%|##########| 299/299 [00:09&lt;00:00, 41.15it/s]
100%|##########| 299/299 [00:09&lt;00:00, 32.39it/s]
Best alignment with the events shifted 12 ms relative to the first behavior event
errors: min -43, q1 -9, med 1, q3 9, max 75
Excluding events that have zero close events or more than one photodiode event within `max_len` time
Excluding event 44, off by -37 ms
Excluding event 56, off by -37 ms
Excluding event 71, off by 31 ms
Excluding event 154, off by 37 ms
Excluding event 209, off by 30 ms
Excluding event 238, no event found
Excluding event 266, off by -33 ms
Excluding event 274, no event found
Excluding event 281, off by -43 ms
</pre></div>
</div>
<p>Find cessations of the photodiode deflections</p>
<p>Another piece of information in the photodiode channel is the cessation of
the events. Let’s find those and add them to the events.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pd_parser</span><span class="o">.</span><span class="n">add_pd_off_events</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">off_event_name</span><span class="o">=</span><span class="s1">&#39;Stim Off&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>Reading in /var/folders/s4/y1vlkn8d70jfw7s8s03m9p540000gn/T/tmp_mne_tempdir_9tocoov8/sub-1_task-mytask_raw.fif
Opening raw data file /var/folders/s4/y1vlkn8d70jfw7s8s03m9p540000gn/T/tmp_mne_tempdir_9tocoov8/sub-1_task-mytask_raw.fif...
Isotrak not found
    Range : 0 ... 2036103 =      0.000 ...  2036.103 secs
Ready.
Reading 0 ... 2036103  =      0.000 ...  2036.103 secs...
Overwriting existing file.
</pre></div>
</div>
<p>Check recovered event lengths and compare to the simulation ground truth</p>
<p>Let’s load in the on and off events and plot their difference compared to
the <code class="docutils literal notranslate"><span class="pre">n_secs_on</span></code> event lengths we used to simulate.
The plot below show the differences between the simulated
deflection event lengths on the x axis scattered against the
recovered event lengths on the y axis. The identity line (the line with 1:1
correspondance) is not shown as it would occlude the plotted data; the
the lengths are recovered within 1 millisecond. Note that the colors are
arbitrary and are only used to increase contrast and ease of visualization.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">annot</span><span class="p">,</span> <span class="n">pd_ch_names</span><span class="p">,</span> <span class="n">beh</span> <span class="o">=</span> <span class="n">_load_data</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
<span class="n">raw</span><span class="o">.</span><span class="n">set_annotations</span><span class="p">(</span><span class="n">annot</span><span class="p">)</span>
<span class="n">events</span><span class="p">,</span> <span class="n">event_id</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">events_from_annotations</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
<span class="n">on_events</span> <span class="o">=</span> <span class="n">events</span><span class="p">[</span><span class="n">events</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">event_id</span><span class="p">[</span><span class="s1">&#39;Stim On&#39;</span><span class="p">]]</span>
<span class="n">off_events</span> <span class="o">=</span> <span class="n">events</span><span class="p">[</span><span class="n">events</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">event_id</span><span class="p">[</span><span class="s1">&#39;Stim Off&#39;</span><span class="p">]]</span>

<span class="n">recovered</span> <span class="o">=</span> <span class="p">(</span><span class="n">off_events</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">on_events</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">raw</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;sfreq&#39;</span><span class="p">]</span>
<span class="n">not_corrupted</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="o">!=</span> <span class="s1">&#39;n/a&#39;</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">beh</span><span class="p">[</span><span class="s1">&#39;pd_parser_sample&#39;</span><span class="p">]]</span>
<span class="n">ground_truth_not_corrupted</span> <span class="o">=</span> <span class="n">n_secs_on</span><span class="p">[</span><span class="n">not_corrupted</span><span class="p">]</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">ground_truth_not_corrupted</span><span class="p">,</span> <span class="n">recovered</span><span class="p">,</span>
           <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">rainbow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">recovered</span><span class="p">))))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Photodiode offset eventfidelity of recovery&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;ground truth duration (s)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;recovered duration (s)&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Mean difference in the recovered from simulated length is </span><span class="si">{:.3f}</span><span class="s1"> &#39;</span>
      <span class="s1">&#39;milliseconds&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
          <span class="mi">1000</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ground_truth_not_corrupted</span> <span class="o">-</span> <span class="n">recovered</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()))</span>
</pre></div>
</div>
<img alt="Photodiode offset eventfidelity of recovery" class="sphx-glr-single-img" src="../_images/sphx_glr_plot_find_pd_on_and_off_003.png" />
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>Reading in /var/folders/s4/y1vlkn8d70jfw7s8s03m9p540000gn/T/tmp_mne_tempdir_9tocoov8/sub-1_task-mytask_raw.fif
Opening raw data file /var/folders/s4/y1vlkn8d70jfw7s8s03m9p540000gn/T/tmp_mne_tempdir_9tocoov8/sub-1_task-mytask_raw.fif...
Isotrak not found
    Range : 0 ... 2036103 =      0.000 ...  2036.103 secs
Ready.
Used Annotations descriptions: [&#39;Stim Off&#39;, &#39;Stim On&#39;]
Mean difference in the recovered from simulated length is 0.252 milliseconds
</pre></div>
</div>
<p class="sphx-glr-timing"><strong>Total running time of the script:</strong> ( 0 minutes  22.081 seconds)</p>
<div class="sphx-glr-footer class sphx-glr-footer-example docutils container" id="sphx-glr-download-auto-examples-plot-find-pd-on-and-off-py">
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../_downloads/fb5c5b7987665badd299d9a46518fdc1/plot_find_pd_on_and_off.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">plot_find_pd_on_and_off.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../_downloads/5a16fa2b3158185b4d69c20afbbe9c0d/plot_find_pd_on_and_off.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">plot_find_pd_on_and_off.ipynb</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2020, Alex Rockhill.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 3.3.1.<br/>
    </p>
  </div>
</footer>
  </body>
</html>