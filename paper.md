---
title: '``pd-parser``: A tool for Matching Photodiode Deflection Events to Time-Stamped Events'
tags:
  - Python
  - neuroscience
  - electrophysiology
  - psychology
  - behavior
authors:
  - name: Alexander P. Rockhill, 
    orcid: 0000-0003-3868-7453
    affiliation: 1
  - name : Ahmed M. Raslan
    orcid: 0000-0002-8421-7105
    affiliation: 2
  - name: Nicole C. Swann
    orcid: 0000-0003-2463-5134
    affiliation: 1
affiliations:
 - name: University of Oregon, Department of Human Physiology
   index: 1
 - name: Department of Neurological Surgery, Oregon Health & Science University, Portland, Oregon.
   index: 2
date: 25 August 2020
bibliography: paper.bib
---

# Summary

``pd-parser`` matches deflection events on a potentially corrupted photodiode channel with time-stamped events generated by the computer that changes the luminance sensed by the photodiode. First, photodiode time series data is extracted from an electrophysiology data file using mne [@Agramfort2013] for input/output. The photodiode data can be on a single channel or two channels that are then bipolar re-referenced. Candidate photodiode events from this photodiode time series are identified based on matching a square-wave template. Time-stamped events from the computer triggering changes to the luminance of the photodiode are read from a tab-separated value (tsv) file, and the best alignment of these events relative to photodiode deflection events is then found while accounting for any drift between computer clocks of separate recording devices. Events are excluded where when the difference between the photodiode event and the time-stamped event are greater then a specified threshold. This discrepancy in timing can occur when a monitor doesn't update the display for one or more frames most often because the computer paused execution of the program controlling luminance to do background tasks. Additional events can then be added using the time of each event relative to the corresponding photodiode-synchronized event. Adding relative events may be needed for any number of reasons. For instance, events may occur too rapidly in series relative to the monitor refresh rate to have a photodiode deflection for each event, or the photodiode deflection may effect neighboring channels on the amplifier with its large deflection and so be placed synchronous with an event, such the onset of fixation, where it will not effect other, more important events. Finally, the raw data and events data can be saved in brain imaging data structure (BIDS) format, which allows the behavioral events to be stored in a standardized format without modifying the underlying raw electrophysiology file.

# Statement of need 

To our knowledge, there are no software packages that extract photodiode events and align them with event time stamps, despite the widespread use of photodiodes for task timing. By sensing luminance, photodiodes can synchronize recording systems with high temporal precision. For example, synchronizing behavioral tasks displayed on a laptop to electrophysiological recordings. While many specially designed research systems are setup to handle triggers to link recordings from separate machines directly, other recording systems, especially clinical systems, lack this capability. In these cases, use of a photodiode offers a robust and reliable method for synchronization. We developed this software package to address our need for intracranial recordings acquired in the epilepsy monitoring unit. Here electrophysiology was acquired using a clinical system and a behavioral task was performed using a laptop brought to the patients bedside. A photodiode placed on the monitor of the laptop was used to detect task-related luminance changes. The photodiode recordings were then digitized by the same clinical recording system which was used for the electrophysiology recordings. Due to variability in refresh rates for monitors, the use of photodiodes is especially helpful for research where precision timing of the display is critical, for example vision or psychophysics research. This software package addresses photodiode synchronization in a comprehensive way so that photodiode parsing can be done by flexibly changing key parameters avoiding writing entirely new scripts. This reduces redundancy, inefficiency and potential for errors.

``pd_parser`` handles complex photodiode parsing for all setups, making it a one-size-fits-all tool for research using photodiode synchronization. Ideal photodiode signals (with minimal noise or drift and clear deflections) would not require a complex algorithm, but in actual experimental setups, photodiode signals are often unideal. This is especially true in clinical settings where elements of the environment may be outside of experimenter control. Often the baseline value of photodiode change over time, the plateaus of photodiode events trend back toward baseline and overshoot after deflection cessation and artifacts contaminate the photodiode signal. These artifacts in the photodiode channel can be caused by movement of the photodiode device, changes in the room lighting, hospital equipment or any number of other issues. This package has robust photodiode event-determination and photodiode to time-stamp alignment algorithms that are validated with both real and simulated photodiode data. The parameters to parse a photodiode channel can be unique to the particular setup (how long the photodiode is on, what the inter-event interval is and what the amplitude of the on period compared to the baseline is), which can be found with an interactive GUI if the default parameters do not work. ``pd-parser`` can accommodate synchronizing a multi-step task based on one time-stamped event with all other events relative to that event, or multiple photodiode-synchronized events parsed separately, in case a researcher chooses to trigger the photodiode for each event in a multi-step task. Existing (unpublished) algorithms are generally written for specific projects and lack flexibility, leading to the creation of redundant algorithms that, due to this redundancy, are vulnerable to coding errors. Not only does pd-parser offer this flexibility but it also serves a forum where new issues can be identified and addressed by the ``pd-parser`` community so that they can be fixed once for all groups. Finally, ``pd-parser`` integrates with BIDS [@Gorgolewski2016; @Niso2018; @Pernet2019; @Holdgraf2019] using ``mne-bids `` [@Appelhoff2019] to store the extracted event data in a standardized data structure improving the reproducibility of the project using photodiode data. The well-tested instructions, Application Programming Interface (API) and Command Line Interface (CLI) make ``pd-parser`` easy to use and encourage both careful photodiode synchronization and adoption of the BIDS community standard. Without careful consideration of the early, low-level steps, such as photodiode synchronization, potential errors could be carried forward in subsequent, more complex analyses, potentially resulting in incorrect conclusions.

# Acknowledgements

We acknowledge support from the Ren√©e James Seed grant to Accelerate Scientific Research from University of Oregon.

# References